<?xml version="1.0" encoding="UTF-8"?>
<project name="EASy-Nightly-UpdateSite" default="createUpdateSite" basedir=".">
    <property file="${user.home}/global-build.properties"/>
    
    <path id="jsch.lib"><pathelement location="${user.home}/addtionalLibs/jsch/jsch-0.1.50.jar"/></path>
    <path id ="task.libs">
		<!-- Libs of the Task -->
		<fileset dir="task">
			<include name="**/*.jar" />
		</fileset>
	</path>
    
    <taskdef name="plugins"
        classname="de.uni_hildesheim.sse.easy.standalone.versionReplacement.PluginsVersion"
        classpathref="task.libs"/>
    <taskdef name="features"
        classname="de.uni_hildesheim.sse.easy.standalone.versionReplacement.FeatureVersion"
        classpathref="task.libs"/>
    <taskdef name="updateSite"
        classname="de.uni_hildesheim.sse.easy.standalone.versionReplacement.UpdateSiteTask"
        classpathref="task.libs"/>
    <property name="version" value="0.55"/>
    
	<target name="createUpdateSite">
        <delete dir="gen"/>
        <mkdir dir="gen"/>
        <mkdir dir="gen/intermediate"/>
        <mkdir dir="gen/intermediate/plugins"/>
        <mkdir dir="gen/intermediate/features"/>
        <mkdir dir="gen/final"/>
        
        <tstamp>
            <format property="TODAY_DE" pattern="yyyyMMdd" locale="de,DE"/>
        </tstamp>
        
        <antcall target="replacePlugins"/>
        <antcall target="createFeature"/>
        <antcall target="createSiteXML"/>
        <antcall target="createArtifactJars"/>
        <antcall target="zip.Site"/>
        <antcall target="publish"/>
    </target>
    
    <target name="replacePlugins">
        <delete dir="gen/tmp"/>
        <mkdir dir="gen/tmp"/>
        <plugins TempFolder="gen/tmp" SourceXML="${user.home}/Eclipse/EASyPlugins" version="${version}.${TODAY_DE}" Destination="gen/intermediate/plugins"/>
    </target>
    
    <target name="createFeature">
        <features SourceXML="feature.xml" version="${version}.${TODAY_DE}" Destination="gen/intermediate/features/EASy.Nightly.Feature.jar"/>
    </target>
    
    <target name="createSiteXML">
        <updateSite SourceXML="site.xml" version="${version}.${TODAY_DE}" Destination="gen/intermediate/site.xml"/>
    </target>
    
    <target name="createArtifactJars">
        <java jar="${eclipse.home}/plugins/org.eclipse.equinox.launcher_1.3.0.v20130327-1440.jar" fork="true" failonerror="true" maxmemory="128m">
            <arg value="-application" />
            <arg value="org.eclipse.equinox.p2.publisher.UpdateSitePublisher" />
            <arg value="-metadataRepository" />
            <arg value="file:${basedir}/gen/final" />
            <arg value="-artifactRepository" />
            <arg value="file:${basedir}/gen/final" />
            <arg value="-source" />
            <arg value="${basedir}/gen/intermediate" />
            <arg value="-compress" />
            <arg value="-publishArtifacts" />
        </java>
    </target>
    
    <target name="zip.Site">
        <zip destfile="gen/Update-Site.zip" basedir="gen/final"/>
    </target>
    
    <target name="publish">
        <sshexec host="projects.sse.uni-hildesheim.de" username="jenkins" trust="true" keyfile="${user.home}/.ssh/id_rsa" command="rm -R /var/www/eclipse/update-sites/easy_nightly/*"/>
        <scp todir="jenkins@projects.sse.uni-hildesheim.de:/var/www/eclipse/update-sites/easy_nightly" trust="true" keyfile="${user.home}/.ssh/id_rsa">
            <fileset dir="${basedir}/gen/final">
                <include name="**/*"/>
            </fileset>
        </scp>
    </target>
</project>
